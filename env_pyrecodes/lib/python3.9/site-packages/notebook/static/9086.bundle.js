"use strict";(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[9086],{89086:(e,t,i)=>{i.r(t),i.d(t,{CONTEXT_PROVIDER_ID:()=>E,Completer:()=>S,CompleterModel:()=>_,CompletionHandler:()=>c,CompletionProviderManager:()=>L,CompletionTriggerKind:()=>s,ContextCompleterProvider:()=>T,ICompletionProviderManager:()=>l,KERNEL_PROVIDER_ID:()=>q,KernelCompleterProvider:()=>H,ProviderReconciliator:()=>k});var s,n=i(26816),o=i(49503),r=i(81997),a=i(20998);!function(e){e[e.Invoked=1]="Invoked",e[e.TriggerCharacter=2]="TriggerCharacter",e[e.TriggerForIncompleteCompletions=3]="TriggerForIncompleteCompletions"}(s||(s={}));const l=new a.Token("@jupyterlab/completer:ICompletionProviderManager","A service for the completion providers management."),d="jp-mod-completer-enabled",h="jp-mod-completer-active";class c{constructor(e){this._editor=null,this._enabled=!1,this._isDisposed=!1,this._autoCompletion=!1,this.completer=e.completer,this.completer.selected.connect(this.onCompletionSelected,this),this.completer.visibilityChanged.connect(this.onVisibilityChanged,this),this._reconciliator=e.reconciliator}set reconciliator(e){this._reconciliator=e}get editor(){return this._editor}set editor(e){if(e===this._editor)return;let t=this._editor;if(t&&!t.isDisposed){const e=t.model;t.host.classList.remove(d),t.host.classList.remove(h),e.selections.changed.disconnect(this.onSelectionsChanged,this),e.sharedModel.changed.disconnect(this.onTextChanged,this)}if(this.completer.reset(),this.completer.editor=e,t=this._editor=e,t){const e=t.model;this._enabled=!1,e.selections.changed.connect(this.onSelectionsChanged,this),e.sharedModel.changed.connect(this.onTextChanged,this),this.onSelectionsChanged()}}get isDisposed(){return this._isDisposed}set autoCompletion(e){this._autoCompletion=e}get autoCompletion(){return this._autoCompletion}dispose(){this.isDisposed||(this._isDisposed=!0,r.Signal.clearData(this))}invoke(){o.MessageLoop.sendMessage(this,c.Msg.InvokeRequest)}processMessage(e){e.type===c.Msg.InvokeRequest.type&&this.onInvokeRequest(e)}getState(e,t){return{text:e.model.sharedModel.getSource(),line:t.line,column:t.column}}onCompletionSelected(e,t){const i=e.model,s=this._editor;if(!s||!i)return;const n=i.createPatch(t);if(!n)return;const{start:o,end:r,value:a}=n,l=s.getOffsetAt(s.getCursorPosition());s.model.sharedModel.updateSource(o,r,a),l<=r&&l>=o&&s.setCursorPosition(s.getPositionAt(o+a.length))}onInvokeRequest(e){if(!this.completer.model)return;if(this.completer.model.original)return;const t=this._editor;t&&this._makeRequest(t.getCursorPosition(),s.Invoked).catch((e=>{console.warn("Invoke request bailed",e)}))}onSelectionsChanged(){const e=this.completer.model,t=this._editor;if(!t)return;const i=t.host;if(!e)return this._enabled=!1,void i.classList.remove(d);if(e.subsetMatch)return;const s=t.getCursorPosition(),n=t.getLine(s.line);if(!n)return this._enabled=!1,e.reset(!0),void i.classList.remove(d);const{start:o,end:r}=t.getSelection();return o.column!==r.column||o.line!==r.line||n.slice(0,s.column).match(/^\s*$/)?(this._enabled=!1,e.reset(!0),void i.classList.remove(d)):(this._enabled||(this._enabled=!0,i.classList.add(d)),void e.handleCursorChange(this.getState(t,t.getCursorPosition())))}onTextChanged(e,t){const i=this.completer.model;if(!i||!this._enabled)return;const n=this.editor;if(!n)return;this._autoCompletion&&this._reconciliator.shouldShowContinuousHint&&this._reconciliator.shouldShowContinuousHint(this.completer.isVisible,t)&&this._makeRequest(n.getCursorPosition(),s.TriggerCharacter);const{start:o,end:r}=n.getSelection();o.column===r.column&&o.line===r.line&&i.handleTextChange(this.getState(n,n.getCursorPosition()))}onVisibilityChanged(e){e.isDisposed||e.isHidden?this._editor&&(this._editor.host.classList.remove(h),this._editor.focus()):this._editor&&this._editor.host.classList.add(h)}_makeRequest(e,t){const i=this.editor;if(!i)return Promise.reject(new Error("No active editor"));const s=i.model.sharedModel.getSource(),o=n.Text.jsIndexToCharIndex(i.getOffsetAt(e),s),r=this.getState(i,e),a={text:s,offset:o};return this._reconciliator.fetch(a,t).then((e=>{if(!e)return;const t=this._updateModel(r,e.start,e.end);t&&t.setCompletionItems&&t.setCompletionItems(e.items)})).catch((e=>{}))}_updateModel(e,t,i){const s=this.completer.model,o=e.text;return s?(s.original=e,s.cursor={start:n.Text.charIndexToJsIndex(t,o),end:n.Text.charIndexToJsIndex(i,o)},s):null}}!function(e){let t;!function(e){e.InvokeRequest=new o.Message("invoke-request")}(t=e.Msg||(e.Msg={}))}(c||(c={}));var u,m=i(33625);function p(e){const t=document.createElement("span");return t.textContent=e,t.innerHTML}class _{constructor(){this._current=null,this._cursor=null,this._isDisposed=!1,this._completionItems=[],this._processedItemsCache=null,this._original=null,this._query="",this._subsetMatch=!1,this._typeMap={},this._orderedTypes=[],this._stateChanged=new r.Signal(this),this._queryChanged=new r.Signal(this),this._resolvingItem=0}get stateChanged(){return this._stateChanged}get queryChanged(){return this._queryChanged}get original(){return this._original}set original(e){this._original===e||this._original&&e&&a.JSONExt.deepEqual(e,this._original)||(this._reset(),this._current=this._original=e,this._stateChanged.emit(void 0))}get current(){return this._current}set current(e){if(this._current===e||this._current&&e&&a.JSONExt.deepEqual(e,this._current))return;const t=this._original;if(!t)return;const i=this._cursor;if(!i)return;const s=this._current=e;if(!s)return void this._stateChanged.emit(void 0);const n=t.text.split("\n")[t.line],o=s.text.split("\n")[s.line];if(!this._subsetMatch&&o.length<n.length)return void this.reset(!0);const{start:r,end:l}=i;let d=s.text.substring(r);const h=t.text.substring(l);d=d.substring(0,d.lastIndexOf(h)),this._query=d,this._processedItemsCache=null,this._queryChanged.emit({newValue:this._query,origin:"editorUpdate"}),this._stateChanged.emit(void 0)}get cursor(){return this._cursor}set cursor(e){this.original&&(this._cursor=e)}get query(){return this._query}set query(e){this._query=e,this._processedItemsCache=null,this._queryChanged.emit({newValue:this._query,origin:"setter"})}get subsetMatch(){return this._subsetMatch}set subsetMatch(e){this._subsetMatch=e}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._isDisposed=!0,r.Signal.clearData(this))}completionItems(){if(!this._processedItemsCache){let e=this._query;this._processedItemsCache=e?this._markup(e):this._completionItems.map((e=>this._escapeItemLabel(e)))}return this._processedItemsCache}setCompletionItems(e){a.JSONExt.deepEqual(e,this._completionItems)||(this._completionItems=e,this._orderedTypes=u.findOrderedCompletionItemTypes(this._completionItems),this._processedItemsCache=null,this._stateChanged.emit(void 0))}typeMap(){return this._typeMap}orderedTypes(){return this._orderedTypes}handleCursorChange(e){if(!this._original)return;const{column:t,line:i}=e,{current:s,original:n}=this;if(!n)return;if(i!==n.line)return void this.reset(!0);if(t<n.column)return void this.reset(!0);const{cursor:o}=this;if(!o||!s)return;const r=o.end-o.start,a=n.text.split("\n")[n.line],l=s.text.split("\n")[s.line].length-a.length;t>n.column+r+l&&this.reset(!0)}handleTextChange(e){const t=this._original;if(!t)return;const{text:i,column:s,line:n}=e,o=i.split("\n")[n][s-1];o&&o.match(/\S/)||e.column>=t.column?this.current=e:this.reset(!1)}createPatch(e){const t=this._original,i=this._cursor,s=this._current;if(!t||!i||!s)return;let{start:n,end:o}=i;return o+=s.text.length-t.text.length,{start:n,end:o,value:e}}reset(e=!1){!e&&this._subsetMatch||(this._reset(),this._stateChanged.emit(void 0))}_markup(e){var t;const i=this._completionItems;let s=[];for(let n of i){const i=n.label.indexOf("("),o=i>-1?n.label.substring(0,i):n.label,r=m.StringExt.matchSumOfSquares(p(o),e);if(r){let e=m.StringExt.highlight(p(n.label),r.indices,u.mark);const i=Object.assign({},n);i.label=e.join(""),i.insertText=null!==(t=n.insertText)&&void 0!==t?t:n.label,s.push({item:i,score:r.score})}}return s.sort(u.scoreCmp),s.map((e=>e.item))}resolveItem(e){const t=++this._resolvingItem;let i;if(!this.completionItems)return;let s=this._completionItems;if(!s||!s[e])return;let n=s[e];if(n.resolve){let e;n.insertText&&(e=this.createPatch(n.insertText)),i=n.resolve(e)}else i=Promise.resolve(n);return i.then((e=>(this._escapeItemLabel(e,!0),Object.keys(e).forEach((t=>{n[t]=e[t]})),n.resolve=void 0,t!==this._resolvingItem?Promise.resolve(null):e))).catch((e=>(console.error(e),Promise.resolve(n))))}_escapeItemLabel(e,t=!1){var i;const s=p(e.label);if(s!==e.label){const n=t?e:Object.assign({},e);return n.insertText=null!==(i=e.insertText)&&void 0!==i?i:e.label,n.label=s,n}return e}_reset(){const e=this._query;this._current=null,this._cursor=null,this._completionItems=[],this._original=null,this._query="",this._processedItemsCache=null,this._subsetMatch=!1,this._typeMap={},this._orderedTypes=[],e&&this._queryChanged.emit({newValue:this._query,origin:"reset"})}}!function(e){const t=["function","instance","class","module","keyword"],i=t.reduce(((e,t)=>(e[t]=null,e)),{});e.mark=function(e){return`<mark>${e}</mark>`},e.scoreCmp=function(e,t){var i,s,n;const o=e.score-t.score;return 0!==o?o:null!==(n=null===(i=e.item.insertText)||void 0===i?void 0:i.localeCompare(null!==(s=t.item.insertText)&&void 0!==s?s:""))&&void 0!==n?n:0},e.findOrderedCompletionItemTypes=function(e){const i=new Set;e.forEach((e=>{!e.type||t.includes(e.type)||i.has(e.type)||i.add(e.type)}));const s=Array.from(i);return s.sort(((e,t)=>e.localeCompare(t))),t.concat(s)},e.findOrderedTypes=function(e){const s=Object.keys(e).map((t=>e[t])).filter((e=>!!e&&!(e in i))).sort(((e,t)=>e.localeCompare(t)));return t.concat(s)}}(u||(u={}));var g=i(58347),v=i(76061),C=i(87112),f=i(18395),y=i(9267);const x="jp-Completer-item",w="jp-mod-active",I="jp-Completer-list",b="jp-Completer-docpanel",P=!0;class S extends y.Widget{constructor(e){var t,i,s,n;super({node:document.createElement("div")}),this._activeIndex=0,this._editor=null,this._model=null,this._selected=new r.Signal(this),this._visibilityChanged=new r.Signal(this),this._indexChanged=new r.Signal(this),this._lastSubsetMatch="",this._geometryLock=!1,this._geometryCounter=0,this._docPanelExpanded=!1,this._renderCounter=0,this.sanitizer=null!==(t=e.sanitizer)&&void 0!==t?t:new g.Sanitizer,this._defaultRenderer=S.getDefaultRenderer(this.sanitizer),this._renderer=null!==(i=e.renderer)&&void 0!==i?i:this._defaultRenderer,this.model=null!==(s=e.model)&&void 0!==s?s:null,this.editor=null!==(n=e.editor)&&void 0!==n?n:null,this.addClass("jp-Completer"),this._updateConstraints()}_updateConstraints(){const e=document.createElement("div");e.classList.add(I),e.style.visibility="hidden",e.style.overflowY="scroll",document.body.appendChild(e);const t=window.getComputedStyle(e);this._maxHeight=parseInt(t.maxHeight,10),this._minHeight=parseInt(t.minHeight,10),this._scrollbarWidth=e.offsetWidth-e.clientWidth,document.body.removeChild(e);const i=document.createElement("div");i.classList.add(b),this._docPanelWidth=M.measureSize(i,"inline-block").width}get activeIndex(){return this._activeIndex}get editor(){return this._editor}set editor(e){this._editor=e}get selected(){return this._selected}get visibilityChanged(){return this._visibilityChanged}get indexChanged(){return this._indexChanged}get model(){return this._model}set model(e){(e||this._model)&&e!==this._model&&(this._model&&(this._model.stateChanged.disconnect(this.onModelStateChanged,this),this._model.queryChanged.disconnect(this.onModelQueryChanged,this)),this._model=e,this._model&&(this._model.stateChanged.connect(this.onModelStateChanged,this),this._model.queryChanged.connect(this.onModelQueryChanged,this)))}set showDocsPanel(e){this._showDoc=e}get showDocsPanel(){return this._showDoc}dispose(){this._sizeCache=void 0,this._model=null,super.dispose()}handleEvent(e){if(!this.isHidden&&this._editor)switch(e.type){case"keydown":this._evtKeydown(e);break;case"mousedown":this._evtMousedown(e);break;case"scroll":this._evtScroll(e)}}reset(){this._activeIndex=0,this._lastSubsetMatch="",this._model&&this._model.reset(!0),this._sizeCache=void 0,this.node.scrollTop=0}selectActive(){const e=this.node.querySelector(`.${w}`);e?(this._selected.emit(e.getAttribute("data-value")),this.reset()):this.reset()}onAfterAttach(e){document.addEventListener("keydown",this,P),document.addEventListener("mousedown",this,P),document.addEventListener("scroll",this,P)}onBeforeDetach(e){document.removeEventListener("keydown",this,P),document.removeEventListener("mousedown",this,P),document.removeEventListener("scroll",this,P)}onModelStateChanged(){this.isAttached&&(this._activeIndex=0,this._indexChanged.emit(this._activeIndex),this.update())}onModelQueryChanged(e,t){if(this._sizeCache&&"editorUpdate"===t.origin){const t=e.completionItems(),i=this._sizeCache.items,s=i[this._findWidestItemIndex(i)],n=t[this._findWidestItemIndex(t)],o=this._getPreferredItemWidthHeuristic();t.length===this._sizeCache.items.length&&o(s)===o(n)||(this._sizeCache=void 0)}}onUpdateRequest(e){var t;const i=this._model;if(!i)return;i.query||this._populateSubset();let s=i.completionItems();if(!s.length)return void(this.isHidden||(this.reset(),this.hide(),this._visibilityChanged.emit(void 0)));this._updateConstraints(),this._geometryLock=!0;const n=this._createCompleterNode(i,s);if(n.querySelectorAll(`.${x}`)[this._activeIndex].classList.add(w),this._showDoc){let e=document.createElement("div");e.className=b,this._docPanel=e,n.appendChild(e),this._docPanelExpanded=!1}const o=null===(t=this.model)||void 0===t?void 0:t.resolveItem(this._activeIndex);this._updateDocPanel(o),this.isHidden?(this.show(),this._setGeometry(),this._visibilityChanged.emit(void 0)):this._setGeometry(),this._geometryLock=!1}get sizeCache(){if(this._sizeCache)return{width:this._sizeCache.width,height:this._sizeCache.height}}_createCompleterNode(e,t){const i=++this._renderCounter;let s=this.node;s.textContent="";let n=e.orderedTypes(),o=document.createElement("ul");o.className=I;const r=this._renderer.createCompletionItemNode(t[0],n),a=[r],l=M.measureSize(r,"inline-grid"),d=Math.max(Math.ceil(this._maxHeight/l.height),5),h=Math.min(d+1,t.length),c=performance.now();for(let e=1;e<h;e++){const i=this._renderer.createCompletionItemNode(t[e],n);a.push(i)}for(const e of a)o.appendChild(e);if(d<t.length){const e=this._findWidestItemIndex(t),i=e<a.length?a[e]:this._renderer.createCompletionItemNode(t[e],n),s=M.measureSize(i.cloneNode(!0),"inline-grid");this._sizeCache={height:this._maxHeight,width:s.width+this._scrollbarWidth,items:t}}if(h<t.length){const e=(performance.now()-c)/h,s=Math.max(5,Math.floor(12/e));let r=h,d=a[a.length-1];const u=()=>{if(r>=t.length)return;const e=l.height*(t.length-r);d.style.marginBottom=`${e}px`,requestAnimationFrame((()=>{if(i!=this._renderCounter)return;d.style.marginBottom="";const e=Math.min(t.length,r+s);for(let i=r;i<e;i++){const e=this._renderer.createCompletionItemNode(t[i],n);o.appendChild(e),d=e}r=e,u()}))};u()}return s.appendChild(o),s}_findWidestItemIndex(e){const t=this._getPreferredItemWidthHeuristic(),i=e.map(t);return i.indexOf(Math.max(...i))}_getPreferredItemWidthHeuristic(){return this._renderer.itemWidthHeuristic?this._renderer.itemWidthHeuristic.bind(this._renderer):this._defaultRenderer.itemWidthHeuristic.bind(this._defaultRenderer)}_cycle(e){var t;const i=this.node.querySelectorAll(`.${x}`),s=this._activeIndex,n=i.length-1;let o=this.node.querySelector(`.${w}`);switch(o.classList.remove(w),e){case"up":this._activeIndex=0===s?n:s-1;break;case"down":this._activeIndex=s<n?s+1:0;break;case"pageUp":case"pageDown":{const t=this.node.getBoundingClientRect(),i=o.getBoundingClientRect(),r=Math.floor(t.height/i.height),a="pageUp"===e?-1:1;this._activeIndex=Math.min(Math.max(0,s+a*r),n);break}}o=i[this._activeIndex],o.classList.add(w);let r=this.node.querySelector(`.${I}`);f.ElementExt.scrollIntoViewIfNeeded(r,o),this._indexChanged.emit(this._activeIndex);const a=null===(t=this.model)||void 0===t?void 0:t.resolveItem(this._activeIndex);this._updateDocPanel(a)}_evtKeydown(e){if(!this.isHidden&&this._editor)if(this._editor.host.contains(e.target))switch(e.keyCode){case 9:{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=this._model;if(!t)return;const i=t.completionItems();if(i&&1===i.length)return this._selected.emit(i[0].insertText||i[0].label),void this.reset();const s=this._populateSubset();return t.query&&t.query!==this._lastSubsetMatch&&(t.subsetMatch=!0,this._selected.emit(t.query),t.subsetMatch=!1,this._lastSubsetMatch=t.query),s&&this.update(),void this._cycle(e.shiftKey?"up":"down")}case 27:return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),void this.reset();case 33:case 34:case 38:case 40:{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=M.keyCodeMap[e.keyCode];return void this._cycle(t)}default:return}else this.reset()}_evtMousedown(e){if(this.isHidden||!this._editor)return;if(M.nonstandardClick(e))return void this.reset();let t=e.target;for(;t!==document.documentElement;){if(t.classList.contains(x))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this._selected.emit(t.getAttribute("data-value")),void this.reset();if(t===this.node)return e.preventDefault(),e.stopPropagation(),void e.stopImmediatePropagation();t=t.parentElement}this.reset()}_evtScroll(e){if(this.isHidden||!this._editor)return;const{node:t}=this;t.contains(e.target)||requestAnimationFrame((()=>{this._setGeometry()}))}_populateSubset(){const{model:e}=this;if(!e)return!1;const t=e.completionItems(),i=M.commonSubset(t.map((e=>e.insertText||e.label))),{query:s}=e;return!(!i||i===s||0!==i.indexOf(s)||(e.query=i,0))}_setGeometry(){const{node:e}=this,t=this._model,i=this._editor;if(!(i&&t&&t.original&&t.cursor))return;const s=t.cursor.start,n=i.getPositionAt(s),o=i.getCoordinateForPosition(n),r=window.getComputedStyle(e),a=parseInt(r.borderLeftWidth,10)||0,l=parseInt(r.paddingLeft,10)||0,d=i.host.closest(".jp-MainAreaWidget > .lm-Widget")||i.host,h=t.completionItems();this._sizeCache&&this._sizeCache.items.length!==h.length&&(this._sizeCache=void 0),C.HoverBox.setGeometry({anchor:o,host:d,maxHeight:this._maxHeight,minHeight:this._minHeight,node:e,size:this._sizeCache,offset:{horizontal:a+l},privilege:"below",style:r,outOfViewDisplay:{top:"stick-inside",bottom:"stick-inside",left:"stick-inside",right:"stick-outside"}});const c=++this._geometryCounter;this._sizeCache||requestAnimationFrame((()=>{if(c!=this._geometryCounter)return;let t=e.getBoundingClientRect();this._sizeCache={width:t.width,height:t.height,items:h}}))}_updateDocPanel(e){var t,i,s;let n=this._docPanel;if(!n)return;if(this._toggleDocPanel(!0),!e)return void this._toggleDocPanel(!1);n.textContent="";const o=null!==(s=null===(i=(t=this._renderer).createLoadingDocsIndicator)||void 0===i?void 0:i.call(t))&&void 0!==s?s:this._defaultRenderer.createLoadingDocsIndicator();n.appendChild(o),e.then((e=>{var t,i,s;if(e&&n)if(e.documentation){const o=null!==(s=null===(i=(t=this._renderer).createDocumentationNode)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:this._defaultRenderer.createDocumentationNode(e);n.textContent="",n.appendChild(o)}else this._toggleDocPanel(!1)})).catch((e=>console.error(e)))}_toggleDocPanel(e){let t=this._docPanel;if(!t)return;if(e){if(this._docPanelExpanded)return;t.style.display="",this._docPanelExpanded=!0}else{if(!this._docPanelExpanded)return;t.style.display="none",this._docPanelExpanded=!1}const i=this._sizeCache;i&&(i.width+=this._docPanelWidth*(e?1:-1),this._geometryLock||this._setGeometry())}}var M;!function(e){class t{constructor(e){this.sanitizer=(null==e?void 0:e.sanitizer)||new g.Sanitizer}createCompletionItemNode(e,t){let i=this._createWrapperNode(e.insertText||e.label);return e.deprecated&&i.classList.add("jp-Completer-deprecated"),this._constructNode(i,this._createLabelNode(e.label),!!e.type,e.type,t,e.icon)}createDocumentationNode(e){const t=document.createElement("div");t.classList.add("jp-RenderedText");const i=this.sanitizer,s=e.documentation||"";return(0,v.renderText)({host:t,sanitizer:i,source:s}).catch(console.error),t}itemWidthHeuristic(e){var t;return e.label.replace(/<\?mark>/g,"").length+((null===(t=e.type)||void 0===t?void 0:t.length)||0)}createLoadingDocsIndicator(){const e=document.createElement("div");e.classList.add("jp-Completer-loading-bar-container");const t=document.createElement("div");return t.classList.add("jp-Completer-loading-bar"),e.append(t),e}_createWrapperNode(e){const t=document.createElement("li");return t.className=x,t.setAttribute("data-value",e),t}_createLabelNode(e){const t=document.createElement("code");return t.className="jp-Completer-match",t.innerHTML=e,t}_constructNode(e,t,i,s,n,o){if(o){const t=o.element({className:"jp-Completer-type jp-Completer-icon"});e.appendChild(t)}else if(i){const t=document.createElement("span");t.textContent=(s[0]||"").toLowerCase();const i=n.indexOf(s)%10+1;t.className="jp-Completer-type jp-Completer-monogram",t.setAttribute("data-color-index",i.toString()),e.appendChild(t)}else{const t=document.createElement("span");t.className="jp-Completer-monogram",e.appendChild(t)}if(e.appendChild(t),i){e.title=s;const t=document.createElement("code");t.className="jp-Completer-typeExtended",t.textContent=s.toLocaleLowerCase(),e.appendChild(t)}else{const t=document.createElement("span");t.className="jp-Completer-typeExtended",e.appendChild(t)}return e}}let i;e.Renderer=t,e.getDefaultRenderer=function(e){return(!i||e&&i.sanitizer!==e)&&(i=new t({sanitizer:e})),i}}(S||(S={})),function(e){e.keyCodeMap={38:"up",40:"down",33:"pageUp",34:"pageDown"},e.commonSubset=function(e){const t=e.length;let i="";if(t<2)return i;const s=e[0].length;for(let n=0;n<s;n++){const s=e[0][n];for(let o=1;o<t;o++)if(e[o][n]!==s)return i;i+=s}return i},e.nonstandardClick=function(e){return 0!==e.button||e.altKey||e.ctrlKey||e.shiftKey||e.metaKey},e.measureSize=function(e,t){e.isConnected&&console.warn("Measuring connected elements with `measureSize` has side-effects"),e.style.visibility="hidden",e.style.display=t,document.body.appendChild(e);const i=e.getBoundingClientRect();return document.body.removeChild(e),e.removeAttribute("style"),i}}(M||(M={}));class k{constructor(e){this._resolveFactory=(e,t)=>e.resolve?i=>e.resolve(t,this._context,i):void 0,this._fetching=0,this._providers=e.providers,this._context=e.context,this._timeout=e.timeout}async fetch(e,t){const i=++this._fetching;let s=[];for(const n of this._providers){let o;o=n.fetch(e,this._context,t).then((e=>{if(i!==this._fetching)return Promise.reject(void 0);const t=e.items.map((e=>({...e,resolve:this._resolveFactory(n,e)})));return{...e,items:t}}));const r=new Promise((e=>setTimeout((()=>e(null)),this._timeout)));o=Promise.race([o,r]),s.push(o.catch((e=>e)))}const n=Promise.all(s);return this._mergeCompletions(n)}shouldShowContinuousHint(e,t){return this._providers[0].shouldShowContinuousHint?this._providers[0].shouldShowContinuousHint(e,t):this._defaultShouldShowContinuousHint(e,t)}_alignPrefixes(e,t,i){if(t!=i){const t=this._context.editor;if(!t)return e;const s=t.getCursorPosition(),n=t.getLine(s.line);return n?e.map((e=>{if(e.start==i)return e;let t=n.substring(e.start,i);return{...e,items:e.items.map((e=>{let i=e.insertText||e.label;return e.insertText=i.startsWith(t)?i.slice(t.length):i,e}))}})):e}return e}async _mergeCompletions(e){let t=(await e).filter((e=>!(!e||e instanceof Error||!e.items.length)));if(0==t.length)return null;if(1==t.length)return t[0];const i=Math.min(...t.map((e=>e.end))),s=t.map((e=>e.start)),n=Math.min(...s),o=Math.max(...s);t=this._alignPrefixes(t,n,o);const r=new Set,a=new Array;for(const e of t)e.items.forEach((e=>{let t=(e.insertText||e.label).trim();r.has(t)||(r.add(t),a.push(e))}));return{start:o,end:i,items:a}}_defaultShouldShowContinuousHint(e,t){return!e&&(null==t.sourceChange||t.sourceChange.some((e=>null!=e.insert&&e.insert.length>0)))}}const E="CompletionProvider:context";class T{constructor(){this.identifier=E,this.rank=500,this.renderer=null}async isApplicable(e){return!0}fetch(e,t){const i=t.editor;return i?new Promise((e=>{e(D.contextHint(i))})):Promise.reject("No editor")}}var D;!function(e){e.contextHint=function(e){const t=e.getTokenAtCursor(),i=function(e,t){return t.getTokens().filter((t=>0===t.value.indexOf(e.value)&&t.value!==e.value))}(t,e).filter((e=>e.type)).map((e=>e.value)),s=new Set(i),n=new Array;return s.forEach((e=>n.push({label:e}))),{start:t.offset,end:t.offset+t.value.length,items:n}}}(D||(D={}));const q="CompletionProvider:kernel";class H{constructor(){this.identifier=q,this.rank=550,this.renderer=null}async isApplicable(e){var t;return!!(null===(t=e.session)||void 0===t?void 0:t.kernel)}async fetch(e,t){var i;const s=null===(i=t.session)||void 0===i?void 0:i.kernel;if(!s)throw new Error("No kernel for completion request.");const n={code:e.text,cursor_pos:e.offset},o=(await s.requestComplete(n)).content;if("ok"!==o.status)throw new Error("Completion fetch failed to return successfully.");const r=new Array,a=o.metadata._jupyter_types_experimental;return o.matches.forEach(((e,t)=>{a&&a[t]?r.push({label:e,type:a[t].type,insertText:a[t].text}):r.push({label:e})})),{start:o.cursor_start,end:o.cursor_end,items:r}}async resolve(e,t,i){const{editor:s,session:o}=t;if(o&&s){let t=s.model.sharedModel.getSource();const r=s.getCursorPosition();let a=n.Text.jsIndexToCharIndex(s.getOffsetAt(r),t);const l=o.kernel;if(!t||!l)return Promise.resolve(e);if(i){const{start:e,value:s}=i;t=t.substring(0,e)+s,a+=s.length}const d={code:t,cursor_pos:a,detail_level:0},h=(await l.requestInspect(d)).content;return"ok"===h.status&&h.found?(e.documentation=h.data["text/plain"],e):e}return e}shouldShowContinuousHint(e,t){const i=t.sourceChange;return null==i||!i.some((e=>null!=e.delete))&&i.some((t=>null!=t.insert&&("."===t.insert||!e&&t.insert.trim().length>0)))}}class L{constructor(){this._activeProviders=new Set([q,E]),this._providers=new Map,this._panelHandlers=new Map,this._activeProvidersChanged=new r.Signal(this)}get activeProvidersChanged(){return this._activeProvidersChanged}setTimeout(e){this._timeout=e}setShowDocumentationPanel(e){this._panelHandlers.forEach((t=>t.completer.showDocsPanel=e)),this._showDoc=e}setContinuousHinting(e){this._panelHandlers.forEach((t=>t.autoCompletion=e)),this._autoCompletion=e}registerProvider(e){const t=e.identifier;this._providers.has(t)?console.warn(`Completion service with identifier ${t} is already registered`):this._providers.set(t,e)}getProviders(){return this._providers}activateProvider(e){this._activeProviders=new Set([]),e.forEach((e=>{this._providers.has(e)&&this._activeProviders.add(e)})),0===this._activeProviders.size&&(this._activeProviders.add(q),this._activeProviders.add(E)),this._activeProvidersChanged.emit()}async updateCompleter(e){const{widget:t,editor:i}=e,s=t.id,n=this._panelHandlers.get(s);if(n)n.completer.showDocsPanel=this._showDoc,n.autoCompletion=this._autoCompletion,i&&(n.editor=i,n.reconciliator=await this.generateReconciliator(e));else{const i=await this.generateHandler(e);this._panelHandlers.set(t.id,i),t.disposed.connect((e=>{this.disposeHandler(e.id,i)}))}}invoke(e){const t=this._panelHandlers.get(e);t&&t.invoke()}select(e){const t=this._panelHandlers.get(e);t&&t.completer.selectActive()}async generateReconciliator(e){let t=[];for(const i of this._activeProviders){const s=this._providers.get(i);s&&await s.isApplicable(e)&&t.push(s)}return new k({context:e,providers:t,timeout:this._timeout})}disposeHandler(e,t){var i;null===(i=t.completer.model)||void 0===i||i.dispose(),t.completer.dispose(),t.dispose(),this._panelHandlers.delete(e)}async generateHandler(e){var t;const i=[...this._activeProviders][0],s=this._providers.get(i);let n=null!==(t=null==s?void 0:s.renderer)&&void 0!==t?t:S.getDefaultRenderer(e.sanitizer);const o=null==s?void 0:s.modelFactory;let r;r=o?await o.call(s,e):new _;const{sanitizer:a}=e,l=new S({model:r,renderer:n,sanitizer:a});l.showDocsPanel=this._showDoc,l.hide(),y.Widget.attach(l,document.body);const d=await this.generateReconciliator(e),h=new c({completer:l,reconciliator:d});return h.editor=e.editor,h}}}}]);